<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Register</title>
    <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
<div class="container">
    <div class="register-box">
        <div class="form-section">
            <h2>REGISTER</h2>
            <form id="signupForm">
                <input type="email" name="email" id="email" placeholder="Email" required />

                <div class="username-check">
                    <input type="text" name="username" id="username" placeholder="Username" required />
                    <button type="button" class="check-btn" onclick="checkUsername()">check</button>
                </div>

                <input type="password" name="password" id="password" placeholder="Password" required />
                <input type="password" name="passwordCheck" id="passwordCheck" placeholder="Password Check" required />
                <button type="submit" class="signup-btn">sign up</button>
            </form>
        </div>

        <div class="login-section">
            <p>Login here!</p>
            <a th:href="@{/users/login}" class="login-btn">Login</a>
        </div>
    </div>

    <!-- ê³µí†µ ëª¨ë‹¬ì°½ -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <span id="modal-message">ë©”ì‹œì§€</span>
            <button class="close-btn" onclick="closeModal()">âœ–</button>
        </div>
    </div>
</div>

<script>
    // íšŒì›ê°€ì… ë²„íŠ¼ í´ë¦­ ì‹œ ìœ íš¨ì„± ê²€ì‚¬
    document.getElementById("signupForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        try {
            const res = await fetch("/users/register", {
                method: "POST",
                body: formData
            });

            const message = await res.text();

            if (!res.ok) {
                showModal(message);  // ğŸ”¥ ì—ëŸ¬ ë©”ì‹œì§€ ëª¨ë‹¬ ì¶œë ¥
                return;
            }

            // ì„±ê³µ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = "/users/login";
        } catch (err) {
            showModal("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });

    // ìœ ì € ì´ë¦„ ì¤‘ë³µ ì²´í¬
    function checkUsername() {
        const username = document.getElementById("username").value;
        if (!username) {
            showModal("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch(`/users/check?username=${username}`)
            .then(res => res.text())
            .then(message => showModal(message))
            .catch(() => showModal("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
    }

    function showModal(message) {
        document.getElementById("modal-message").innerText = message;
        document.getElementById("modal-overlay").style.display = "flex";
    }

    function closeModal() {
        document.getElementById("modal-overlay").style.display = "none";
    }
</script>
</body>
</html>
