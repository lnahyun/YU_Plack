<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>To-Do List Page</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
<!-- âœ… ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
<div class="navbar">
    <a th:href="@{/users/home}" >HOME</a>
    <a th:href="@{/todos/view(date=${today})}" class="active">TO-DO</a>

    <img src="/images/logo.png" alt="Logo" class="nav-logo" />

    <a th:href="@{/todos/pending}">PENDING</a>
    <a th:href="@{/users/profile}">PROFILE</a>
</div>

<!-- âœ… ì „ì²´ ì»¨í…Œì´ë„ˆ -->
<div class="todo-container">
    <div class="todo-header">
        <button onclick="moveDate(-1)">&#60;</button>
        <span id="selected-date" class="date-text" th:text="${date}"></span>
        <input type="text" id="datepicker" style="position: absolute; opacity: 0; pointer-events: none;" />
        <button onclick="moveDate(1)">&#62;</button>
    </div>

    <div class="todo-box">
        <div th:if="${todos.size() > 0}">
            <div th:each="todo : ${todos}" class="todo-item">
                <!-- âœ… ì²´í¬ë°•ìŠ¤ -->
                <form th:action="@{/todos/toggle/{id}(id=${todo.id})}" method="post" style="display:inline;">
                    <input type="hidden" name="date" th:value="${date}" />
                    <input type="checkbox"
                           name="completed"
                           th:checked="${todo.completed}"
                           onchange="this.form.submit()" />
                </form>

                <!-- âœ… ì¸ë¼ì¸ ìˆ˜ì • input -->
                <form th:action="@{/todos/update/{id}(id=${todo.id})}" method="post" class="inline-edit-form">
                    <input type="text" name="content" th:value="${todo.content}" readonly />
                    <input type="hidden" name="dueDate" th:value="${date}" />
                </form>

                <!-- âœ… ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
                <div class="todo-actions">
                    <button type="button" onclick="enableEdit(this)">âœ</button>
                    <button type="button" th:onclick="|confirmDelete(${todo.id})|">ğŸ—‘</button>
                </div>
            </div>
        </div>

        <div th:if="${todos.size() == 0}" class="empty-message">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>

        <!-- âœ… ì¶”ê°€ input -->
        <form method="post" th:action="@{/todos/add}" onsubmit="return validateAdd()" class="todo-add">
            <input type="text" name="content" id="newTodoContent" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" />
            <input type="hidden" name="dueDate" th:value="${date}" />
            <button type="submit" class="add-btn">ADD</button>
        </form>
    </div>
</div>

<!-- âœ… ëª¨ë‹¬ -->
<div id="modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span id="modal-message">ëª¨ë‹¬ ë©”ì‹œì§€</span>
        <button onclick="closeModal()">âœ–</button>
    </div>
</div>

<script>
    // âœ… datepicker
    let datePickerInstance;
    document.addEventListener('DOMContentLoaded', function () {
        const selectedDateEl = document.getElementById("selected-date");
        datePickerInstance = flatpickr("#datepicker", {
            dateFormat: "Y-m-d",
            defaultDate: selectedDateEl.innerText,
            onChange: function (_, dateStr) {
                location.href = `/todos/view?date=${dateStr}`;
            },
            positionElement: selectedDateEl
        });
        selectedDateEl.addEventListener("click", function () {
            datePickerInstance.open();
        });

        // âœ… ì¸ë¼ì¸ ìˆ˜ì • validation
        document.querySelectorAll(".inline-edit-form input[name='content']").forEach(input => {

            input.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    const value = input.value.trim();
                    if (value === "") {
                        e.preventDefault();
                        showModal("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        input.focus(); // ìœ ì§€
                    } else {
                        input.form.submit();
                    }
                }
            });

            input.addEventListener("blur", function () {
                if (!input.readOnly && input.value.trim() === "") {
                    showModal("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                }
            });
        });
    });

    // âœ… ë‚ ì§œ ì´ë™
    function moveDate(offset) {
        const current = document.getElementById('selected-date').innerText;
        const date = new Date(current);
        date.setDate(date.getDate() + offset);
        const yyyy = date.getFullYear();
        const mm = ('0' + (date.getMonth() + 1)).slice(-2);
        const dd = ('0' + date.getDate()).slice(-2);
        location.href = `/todos/view?date=${yyyy}-${mm}-${dd}`;
    }

    // âœ… í•  ì¼ ì¶”ê°€ì‹œ ê³µë°± ê²€ì‚¬
    function validateAdd() {
        const input = document.getElementById("newTodoContent").value.trim();
        if (input === "") {
            showModal("ì¼ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return false;
        }
        return true;
    }

    // âœ… ì‚­ì œ í™•ì¸
    function confirmDelete(id) {
        const date = document.getElementById('selected-date').innerText;
        if (confirm("í•´ë‹¹ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            location.href = `/todos/delete/${id}?date=${date}`;
        }
    }

    // âœ… ìˆ˜ì • í™œì„±í™”
    function enableEdit(button) {
        const parent = button.closest(".todo-item");
        const input = parent.querySelector("input[name='content']");
        input.removeAttribute("readonly");
        input.focus();
        input.setSelectionRange(input.value.length, input.value.length); // ì»¤ì„œ ë
    }

    // âœ… ëª¨ë‹¬
    function showModal(message) {
        const modal = document.getElementById("modal");
        const modalMessage = document.getElementById("modal-message");
        if (modal && modal.style.display !== "flex") {
            modalMessage.innerText = message;
            modal.style.display = "flex";
        }
    }

    function closeModal() {
        const modal = document.getElementById("modal");
        if (modal) modal.style.display = "none";
    }
</script>
</body>
</html>
